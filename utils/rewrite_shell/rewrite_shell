#!/usr/bin/env python3
from typing import TYPE_CHECKING
from bashlex import parser
from lib.pretty_printer import prettyprinter
from lib.ast_printer import astprinter
from lib.substitution import substitutionvisitor
import sys

# to store variable bindings
env = {}

lines = []
trees = []
shebang = ""

with open(sys.argv[1], "r") as f:
    lines = f.readlines()

for line in lines:
    input = line.strip()
    # bashlex barfs on empty lines
    if len(input) == 0:
        continue

    # bashlex mysteriously does not understand shebangs
    if input[0] == "#" and input[1] == "!":
        shebang = line
        continue

    # otherwise, it's an expression
    trees += parser.parse(input)

for i in range(len(trees)):
    # init visitors
    # ap = astprinter()
    visitor = substitutionvisitor(env)

    # print("line: " + lines[i].strip())

    # DEBUG: print before
    # print("before: ")
    # ap.visit(trees[i])

    # DEBUG: echo command
    # print("command: ")
    # prettyprinter.print(trees[i])

    # do substitutions
    tree2 = visitor.visit(trees[i])

    # DEBUG: print after
    # print("after: ")
    # ap.visit(tree2)

    # echo modified command
    print(shebang, end = "")
    prettyprinter.print(tree2)