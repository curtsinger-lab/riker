version: 2.1

executors:
  default:
    docker:
      - image: circleci/buildpack-deps:bionic
jobs:
  build:
    executor: default
    steps:
      - checkout
      - run: sudo apt-get update
      - run: sudo apt-get install build-essential git capnproto libcapnp-dev graphviz
      - run: git submodule update --init
      - run: make
      - run: ./dodo
      - run: ./dodo --dry-run --visualize
      - run: mv out.dot self-build.dot
      - store_artifacts:
          path: self-build.dot
      - run: dot -Tpdf self-build.dot > self-build.pdf
      - store_artifacts:
          path: self-build.pdf
